@page
@using WebTool.Controllers;
@using Shared
@model WebTool.Pages.Server.Maintenance.Version.BundleVersionModel
@{
    ViewData["Title"] = "번들 버전 관리";
    ViewData["ActiveMenu"] = "/Server/Maintenance/Version/BundleVersion";
}

<div class="row mb-2">
    <div class="content-header">
        <h1 class="text-dark">@ViewData["Title"]</h1>
    </div>
</div>

<div>
    <strong>OS</strong>
    <select id="ostype" style="margin-left:55px;">
        @for (var i = 1; i < Enum.GetValues(typeof(OSType)).Length; i++)
        {
            OSType index = (OSType)i;
            if (index == OSType.Android)
            {
                <option value="@(i)" selected>@index</option>
            }
            else
            {
                <option value="@(i)">@index</option>
            }
        }
    </select>
</div>

<div class="row">
    <div class="col-12" style="margin-top: 20px;">
        <strong>번들 버전</strong>
        <input type="text" id="input-bundle-version" style="margin-left:10px; width:400px;" />
    </div>

    <div class="col-12" style="margin-top: 20px;">
        <strong>번들 URL</strong>
        <input type="text" id="input-bundle-url" style="margin-left:13px; width:400px;" />
    </div>

    <div style="margin-top: 20px;" class="col-5">
        <button type="button" id="bundle-version-upload" class="btn btn-primary float-right" style="margin-left: 20px;">서버 적용</button>
        <button type="button" id="change-bundleinfo" class="btn btn-primary float-right">변경</button>
    </div>
</div>

<div class="row">
    <div class="col-6" style="margin-top: 20px;">
        <table id="bundle-info-table" class="table table-bordered table-striped table-hover dataTable dtr-inline text-center">
            <thead>
                <tr>
                    @foreach (var column in ServerController.BundleInfo)
                    {
                        <th>
                            @column.Name
                        </th>
                    }
                </tr>
            </thead>
        </table>
    </div>
</div>

<div id="loading" style="display: none;">
    <div class="overlay modal d-flex justify-content-center align-items-center" style="background: #00000055;">
        <i class="fas fa-2x fa-sync fa-spin"></i>
    </div>
</div>

@section Scripts {
    <script src="~/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="~/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="~/js/extensions/datatables/lang.js"></script>
    <script src="~/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
    <script>
        let loading = $('#loading');
        let tableRoot = $('#bundle-info-table');
        let changeInfoButton = $('#change-bundleinfo');
        let osType = $('#ostype');
        let bundleVersion = $('#input-bundle-version');
        let bundleUrl = $('#input-bundle-url');
        let bundleUpload = $('#bundle-version-upload');

        bundleUpload.click(function () {
            let osValue = osType.val();
            $.ajax({
                url: '/api/server/upload-bundle',
                type: 'POST',
                data: {
                    OsType: osValue,
                },
                success: function (res) {
                    alert('성공');
                },
                error: function (xhr, status, error) {
                    alert(xhr.responseText);
                },
                complete: function (res) {
                    endLoading();
                }
            });
        });

        changeInfoButton.click(function () {
            let osValue = osType.val();
            let bundleVersionValue = bundleVersion.val();
            let bundleUrlValue = bundleUrl.val();
            startLoading();
            $.ajax({
                url: '/api/server/change-bundleinfo',
                type: 'POST',
                data: {
                    OsType: osValue,
                    Version: bundleVersionValue,
                    Url: bundleUrlValue,
                },
                success: function (res) {
                    alert('성공');
                },
                error: function (xhr, status, error) {
                    alert(xhr.responseText);
                },
                complete: function (res) {
                    endLoading();
                    location.reload();
                }
            });
        });

        $(document).ready(function () {
            showTable();
        });

        function showTable() {
            tableRoot.DataTable({
                language: datatablesLangKor('번들 버전', '번들 URL'),
                autoWidth: false,
                lengthChange: false,
                paging: false,
                searching: false,
                info: false,
                stateSave: true,
                processing: true,
                serverSide: true,
                ajax: {
                    url: '/api/server/load-bundleinfo',
                    type: 'POST',
                    data: {
                    }
                },
                columnDefs: [
                    {
                        targets: 2,
                        orderable: false,
                    },
                ],
                createdRow: function (row, data, dataIndex, cells) {
                }
            });
        }

        function startLoading() {
            loading.show();
        }

        function endLoading() {
            loading.hide();
        }
    </script>
}