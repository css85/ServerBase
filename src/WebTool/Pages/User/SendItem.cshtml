@page
@model WebTool.Pages.User.SendItemModel
@{
    ViewData["Title"] = "아이템 지급";
    ViewData["ActiveMenu"] = "/User/SendItem";

    const int itemSize = 12;
}

<div class="row mb-2">
    <div class="content-header">
        <h1 class="text-dark">@ViewData["Title"]</h1>
    </div>
</div>

<table class="table table-bordered text-center">
    <tbody>
        <tr>
            <td>
                <strong>제목</strong>
            </td>
            <td>
                <div class="row">
                    <div class="col-md-11">
                        <input type="text" class="form-control" id="titleText" onclick="onTitleTextClicked()" readonly="">
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-block btn-info" onclick="onTitleTextClicked()">수정</button>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td>
                <strong>수신인</strong>
            </td>
            <td>
                <div class="row">
                    <div class="col-md-11">
                        <textarea id="sendTargetText" class="form-control" rows="3" placeholder="';'으로 구분된 userSeq"></textarea>
                    </div>
                    <div class="col-md-1">
                        <button id="sendTargetButton" type="button" class="btn btn-block btn-info btn-lg" style="height: 100%" onclick="onUserSelectClicked()">+</button>
                    </div>
                </div>
                @* <div class="row mt-2">
                    <div class="col-md-12">
                        <div>
                            <div class="icheck-primary d-inline mr-2">
                                <input type="radio" id="sendUserRadio1" name="sendUserRadio" value="1">
                                <label for="sendUserRadio1">
                                    모든 유저
                                </label>
                            </div>
                           <div class="icheck-primary d-inline mr-2">
                                <input type="radio" id="sendUserRadio2" name="sendUserRadio" value="2">
                                <label for="sendUserRadio2">
                                    일반 유저
                                </label>
                            </div>
                            <div class="icheck-primary d-inline mr-2">
                                <input type="radio" id="sendUserRadio3" name="sendUserRadio" value="3">
                                <label for="sendUserRadio3">
                                    신규 유저
                                </label>
                            </div>
                            <div class="icheck-primary d-inline mr-2">
                                <input type="radio" id="sendUserRadio4" name="sendUserRadio" value="4">
                                <label for="sendUserRadio4">
                                    복귀할 유저
                                </label>
                            </div>
                            <div class="icheck-primary d-inline mr-2">
                                <input type="radio" id="sendUserRadio5" name="sendUserRadio" value="5" checked="">
                                <label for="sendUserRadio5">
                                    직접 입력
                                </label>
                            </div>
                        </div>
                    </div>
                </div>*@
            </td>
        </tr>
        <tr>
            <td>
                <strong>내용 (선택)</strong>
            </td>
            <td>
                <div class="row">
                    <div class="col-md-11">
                        <input type="text" class="form-control" id="messageText" onclick="onMessageTextClicked()" readonly="">
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-block btn-info" onclick="onMessageTextClicked()">수정</button>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td style="width: 150px;">
                <div class="icheck-primary d-inline">
                    <input type="checkbox" id="getItemAllCheckbox">
                    <label for="getItemAllCheckbox"></label>
                </div>
                <strong>아이템 지급</strong>
            </td>
            <td>
                <div class="row">
                    @for (var i = 0; i < itemSize; i++)
                    {
                        <div class="col-3 mb-2">
                            <div class="icheck-primary">
                                <input type="checkbox" id="itemSelectCheckbox@(i)">
                                <label for="itemSelectCheckbox@(i)"></label>
                            </div>
                            <input type="hidden" id="itemSelectValue@(i)" value="" />
                            <button type="button" id="itemSelectButton@(i)" class="btn btn-info" onclick="onItemSelectClicked(@i)">아이템 선택</button>
                        </div>
                    }
                </div>
            </td>
        </tr>
        <tr>
            <td>
                <strong>수령기한</strong>
                <br />
                <strong>(UTC 기준)</strong>
            </td>
            <td>
                <div class="row">
                    <div class="col-md-3 col-sm-12">
                        <div id="itemExpireTime" class="input-group" data-target-input="nearest">
                            <input type="text" id="itemExpireTimeValue" class="form-control" data-target="#itemExpireTime" />
                            <div class="input-group-append" data-target="#itemExpireTime" data-toggle="datetimepicker">
                                <div class="input-group-text">
                                    <i class="far fa-calendar"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td>
                <input type="checkbox" id="checkReservation"/>
                <strong>예약</strong>
                <br />
                <strong>(UTC 기준)</strong>
            </td>
            <td>
                <div class="row">
                    <div class="col-md-3 col-sm-12">
                        <div id="reservationTime" class="input-group" data-target-input="nearest">
                            <input type="text" id="reservationTimeValue" class="form-control" data-target="#reservationTime" />
                            <div class="input-group-append" data-target="#reservationTime" data-toggle="datetimepicker">
                                <div class="input-group-text">
                                    <i class="far fa-calendar"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
    </tbody>
</table>

<div class="row" style="flex-direction: row-reverse;">
    <button type="button" class="btn btn-primary pl-5 pr-5" onclick="sendItem()">발송</button>
    <div class="icheck-primary d-inline mr-4">
        <input type="checkbox" id="isSendPushCheckbox">
        <label for="isSendPushCheckbox">푸시와 함께 발송</label>
    </div>
</div>

<div id="loading" style="display: none;">
    <div class="overlay modal d-flex justify-content-center align-items-center" style="background: #00000055;">
        <i class="fas fa-2x fa-sync fa-spin"></i>
    </div>
</div>

@section Styles
{
    <link rel="stylesheet" href="~/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css" />
    <link rel="stylesheet" href="~/plugins/select2/css/select2.min.css" />
    <link rel="stylesheet" href="~/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css" />
    <link rel="stylesheet" href="~/plugins/icheck-bootstrap/icheck-bootstrap.min.css" />
    <style>
        table tr td {
            vertical-align: middle !important;
        }
    </style>
}

@section Scripts
{
    <script src="~/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
    <script src="~/plugins/select2/js/select2.min.js"></script>
    <script src="~/plugins/icheck-bootstrap/icheck-bootstrap.min.css"></script>
    <script>
        let reserveMail = $('#checkReservation');

        $(document).ready(function () {
            $('#itemExpireTime').datetimepicker(dateTimePickerOption_UtcAddOneDay);
            $('#reservationTime').datetimepicker(dateTimePickerOption_UtcAddOneDay);

//            initSendUserRadio();
        });

        function initSendUserRadio() {
            $('input[name=sendUserRadio]').change(function() {
                onSendUserRadioChanged();
            });
            onSendUserRadioChanged();
        }

        function onSendUserRadioChanged() {
            var sendUserRadioValue = $('input[name=sendUserRadio]:checked').val();
            if (sendUserRadioValue === '1') {
                $('#sendTargetText').val('/AllUsers');
                $('#sendTargetText').prop('disabled', true);
                $('#sendTargetButton').prop('disabled', true);
            } else if (sendUserRadioValue === '2') {
                $('#sendTargetText').val('/NormalUsers');
                $('#sendTargetText').prop('disabled', true);
                $('#sendTargetButton').prop('disabled', true);
            } else if (sendUserRadioValue === '3') {
                $('#sendTargetText').val('/NewUsers');
                $('#sendTargetText').prop('disabled', true);
                $('#sendTargetButton').prop('disabled', true);
            } else if (sendUserRadioValue === '4') {
                $('#sendTargetText').val('/ToReturnUsers');
                $('#sendTargetText').prop('disabled', true);
                $('#sendTargetButton').prop('disabled', true);
            } else {
                $('#sendTargetText').val('');
                $('#sendTargetText').prop('disabled', false);
                $('#sendTargetButton').prop('disabled', false);
            }
        }

        function onItemSelectClicked(index) {
            openItemSelectPopup(index,
                function(index, name, value) {
                    $('#itemSelectCheckbox' + index).prop('checked', true);
                    $('#itemSelectButton' + index).html(name);
                    $('#itemSelectValue' + index).val(value);
                });
        }

        function onUserSelectClicked() {
            openUserSelectPopup(
                function (userSeq) {
                    var sendUserRadioValue = $('input[name=sendUserRadio]:checked').val();
//                    if (sendUserRadioValue === '5') {
                        var currentText = $('#sendTargetText').val();
                        if (currentText !== '') {
                            currentText += `;${userSeq}`;
                        } else {
                            currentText = `${userSeq}`;
                        }
                        $('#sendTargetText').val(currentText);
//                    }
                });
        }

        function onTitleTextClicked() {
            openLanguageTextInputPopup($('#titleText').val(), 
                function (text) {
                    $('#titleText').val(text);
                }, 1);
        }

        function onMessageTextClicked() {
            openLanguageTextInputPopup($('#messageText').val(), 
                function (text) {
                    $('#messageText').val(text);
                }, 2);
        }

        function sendItem() {
            let titleText = $('#titleText').val();
            let sendTargetText = $('#sendTargetText').val();
            let messageText = $('#messageText').val();

            let items = [];
            let isItemSend = $('#getItemAllCheckbox').is(':checked');
            if (isItemSend) {
                @for (var i = 0; i < itemSize; i++)
                {
                    @: if ($('#itemSelectCheckbox@(i)').is(':checked')) {
                    @:     items.push($('#itemSelectValue@(i)').val());
                    @: }
                }
            }

            // TODO: 아이템 회수
            let itemExpireTime = $('#itemExpireTimeValue').val();
            let reservationTime = $('#reservationTimeValue').val();
            let isSendPush = $('#isSendPushCheckbox').is(':checked');
            let isReserve = reserveMail.is(':checked');

            $.ajax({
                type: 'POST',
                url: '/api/mail/send-mail',
                data: {
                    titleText: titleText,
                    sendTargetText: sendTargetText,
                    messageText: messageText,
                    itemText: items.join(';'),
                    itemExpireTime: itemExpireTime,
                    reservationTime: reservationTime,
                    isSendPush: isSendPush,
                    isReserve: isReserve,
                },
                success: function (response) {
                    alert('성공');
                    location.reload();
                },
                error: function (xhr, status, error) {
                    alert('실패\n' + xhr.responseText);
                },
                complete: function (response) {
                    $('#editModal').modal('hide');
                    endLoading();
                }
            });
        }

        function startLoading() {
            $('#loading').show();
        }

        function endLoading() {
            $('#loading').hide();
        }
    </script>
}