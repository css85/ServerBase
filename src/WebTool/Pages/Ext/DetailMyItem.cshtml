@page
@using WebTool.Controllers;
@model WebTool.Pages.User.UserWindowPopup.DetailMyItemModel
@{
    Layout = "_LayoutContentsOnly";
}
<div class="col-12">
    <div class="card card-primary card-outline card-outline-tabs">
        <div class="card-header p-0 border-bottom-0">
            <ul class="nav nav-tabs" id="tabs" role="tablist">
                @for (var i = 0; i < Model.properties.Length; i++)
                {
                    <li class="nav-item">
                        @if (i == 0)
                        {
                            <a class="nav-link active" data-toggle="tab" data-load="@Model.properties[i].TableType" role="tab" aria-selected="true">@Model.properties[i].TabName</a>
                        }
                        else
                        {
                            <a class="nav-link" data-toggle="tab" role="tab" data-load="@Model.properties[i].TableType" aria-selected="false">@Model.properties[i].TabName</a>
                        }
                    </li>
                }
            </ul>
        </div>
    </div>
</div>

@for (var i = 0; i < Model.properties.Length; i++)
{
    <div id="@Model.properties[i].TableRootId">
        <button type="button" class="btn-dark" style="margin-bottom: 30px;">@Html.ActionLink("엑셀", "ExportItemCSVData", "User", new { userSeq = Model.UserSeq, type = i })</button>
        <table id="@Model.properties[i].TableId" class="table table-striped table-hover dataTable dtr-inline text-center">
            <thead>
                <tr>
                    @foreach (var column in UserController.MyItemDetailTableDataColumnInfos)
                    {
                        <th>
                            @column.Name
                        </th>
                    }
                </tr>
            </thead>
        </table>
    </div>
}

<div>
    <input type="hidden" id="save-user-id" value="@Model.UserSeq" />
</div>

@section Scripts {
    <script src="~/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
    <script src="~/plugins/select2/js/select2.min.js"></script>
    <script src="~/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="~/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="~/js/extensions/datatables/lang.js"></script>
    <script>
        let tableRootArray = new Array(@Model.properties.Length).fill(null);
        let tableArray = new Array(@Model.properties.Length).fill(null);
        let userID = $('#save-user-id');

        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            $this = $(e.target);
            var type = $this.data("load");
            showTable(type);
        });

        $(document).ready(function () {
            tableRootArray[0] = $('#@Model.properties[0].TableRootId');
            tableRootArray[1] = $('#@Model.properties[1].TableRootId');
            tableRootArray[2] = $('#@Model.properties[2].TableRootId');
            tableRootArray[3] = $('#@Model.properties[3].TableRootId');
            showTable(0);
        });

        function showTable(type) {
            for (var i = 0; i < tableRootArray.length; i++) {
                if (tableRootArray[i] != null) {
                    tableRootArray[i].hide();
                }
            }
            let userSeq = userID.val();
            switch (type) {
                case 0:
                    {
                        if (tableArray[0] === null) {
                            tableArray[type] = $('#table-totalItem').DataTable({
                                language: datatablesLangKor('타입', '인덱스', '수량'),
                                autoWidth: true,
                                paging: false,
                                lengthChange: false,
                                searching: false,
                                stateSave: true,
                                info: false,
                                processing: true,
                                serverSide: true,
                                ajax: {
                                    url: '/api/user/item-detail-table-data',
                                    type: 'POST',
                                    data: {
                                        userSeq: userSeq,
                                        type: 0,
                                    },
                                    columnDefs: [
                                        {
                                            target: 1,
                                            orderable: false
                                        }
                                    ],
                                    createRow: function (row, data, dataIndex, cells) {
                                    }
                                }
                            });
                        } else {
                            tableArray[0].ajax.reload();
                        }
                        tableRootArray[0].show();
                    }
                    break;
                case 1:
                    if (tableArray[1] === null) {
                            tableArray[type] = $('#table-buffItem').DataTable({
                            language: datatablesLangKor('타입', '인덱스', '수량'),
                            autoWidth: false,
                            paging: false,
                            lengthChange: false,
                            searching: false,
                            info: false,
                            stateSave: true,
                            processing: true,
                            serverSide: true,
                            ajax: {
                                    url: '/api/user/item-detail-table-data',
                                    type: 'POST',
                                    data: {
                                        userSeq: userSeq,
                                        type: 1,
                                    },
                                    columnDefs: [
                                        {
                                            target: 1,
                                            orderable: false
                                        }
                                    ],
                                    createRow: function (row, data, dataIndex, cells) {
                                    }
                                }
                            });
                        } else {
                            tableArray[1].ajax.reload();
                        }
                        tableRootArray[1].show();
                    break;
                case 2:
                    if (tableArray[2] === null) {
                        tableArray[type] = $('#table-normalItem').DataTable({
                            language: datatablesLangKor('타입', '인덱스', '수량'),
                        autoWidth: false,
                        paging: false,
                        lengthChange: false,
                            searching: false,
                            info: false,
                        stateSave: true,
                        processing: true,
                        serverSide: true,
                        ajax: {
                                url: '/api/user/item-detail-table-data',
                                type: 'POST',
                                data: {
                                    userSeq: userSeq,
                                    type: 2,
                                },
                                columnDefs: [
                                    {
                                        target: 1,
                                        orderable: false
                                    }
                                ],
                                createRow: function (row, data, dataIndex, cells) {
                                }
                            }
                        });
                    } else {
                        tableArray[2].ajax.reload();
                    }
                    tableRootArray[2].show();
                    break;
                case 3:
                    if (tableArray[3] === null) {
                        tableArray[type] = $('#table-couponItem').DataTable({
                            language: datatablesLangKor('타입', '인덱스', '수량'),
                            autoWidth: false,
                            paging: false,
                            lengthChange: false,
                            searching: false,
                            info: false,
                            stateSave: true,
                            processing: true,
                            serverSide: true,
                            ajax: {
                                url: '/api/user/item-detail-table-data',
                                type: 'POST',
                                data: {
                                    userSeq: userSeq,
                                    type: 3,
                                },
                                columnDefs: [
                                    {
                                        target: 1,
                                        orderable: false
                                    }
                                ],
                                createRow: function (row, data, dataIndex, cells) {
                                }
                            }
                        });
                    } else {
                        tableArray[3].ajax.reload();
                    }
                    tableRootArray[3].show();
                    break;
            }
        }
    </script>
}