@page
@using Shared
@using WebTool.Extensions
@model WebTool.Pages.Operation.MessageNotification.SendModel
@{
    ViewData["Title"] = "알림메시지 발송";
    ViewData["ActiveMenu"] = "/Operation/MessageNotification/Send";
}

<div class="row mb-2">
    <div class="content-header">
        <h1 class="text-dark">발송</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <table id="languageTable" class="table table-striped table-bordered" style="display: none; width: 100%;">
            <thead>
            <tr>
                <th>메시지</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>
                    <div class="row">
                        <div class="col-md-11">
                            <input type="text" class="form-control" id="messageText" onclick="onMessageTextClicked()" readonly="">
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-block btn-primary" onclick="onMessageTextClicked()">수정</button>
                        </div>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="col-md-12">
        <div class="row">
            <div class="col-md-2">
                <div id="reservationTime" class="input-group" data-target-input="nearest">
                    <input type="text" id="reservationTimeValue" class="form-control" data-target="#reservation-time"/>
                    <div class="input-group-append" data-target="#reservationTime" data-toggle="datetimepicker">
                        <div class="input-group-text">
                            <i class="far fa-calendar"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-10">
                <div class="col-md-2 float-right" style="padding: 0">
                    <button type="button" class="btn btn-block btn-primary" onclick="reserve()">예약</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div>
    <br/>
</div>

<div class="row mb-2">
    <div class="content-header">
        <h1 class="text-dark">프리셋 설정</h1>
    </div>
</div>

<div class="row mb-2">
    <div class="col-md-3">
        <select id="presetSelect" style="width: 100%">
            @foreach (var item in Model.Presets)
            {
                <option value="@item.Seq">@item.Name</option>
            }
        </select>
    </div>
    <div class="col-md-2">
        <button type="button" class="btn btn-block btn-primary" onclick="addPreset()">프리셋 추가</button>
    </div>
</div>

<div class="row">
    <div class="col-md-3">
        <div class="form-group">
            <label for="presetName">프리셋 이름</label>
            <input type="hidden" class="form-control" id="presetSeq">
            <input type="text" class="form-control" id="presetName">
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <table id="presetLanguageTable" class="table table-striped table-bordered" style="display: none; width: 100%;">
            <thead>
            <tr>
                <th>메시지</th>
            </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <div class="row">
                            <div class="col-md-11">
                                <input type="text" class="form-control" id="presetMessageText" onclick="onPresetMessageTextClicked()" readonly="">
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-block btn-primary" onclick="onPresetMessageTextClicked()">수정</button>
                            </div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="col-md-2 float-right">
            <button type="button" class="btn btn-block btn-primary" onclick="usePreset()">발송에 쓰기</button>
        </div>
        <div class="col-md-2 float-right">
            <button type="button" class="btn btn-block btn-primary" onclick="savePreset()">저장</button>
        </div>
    </div>
</div>

@section Styles
{
    <link rel="stylesheet" href="~/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="~/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
    <link rel="stylesheet" href="~/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css"/>
    <link rel="stylesheet" href="~/plugins/select2/css/select2.min.css"/>
    <link rel="stylesheet" href="~/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css"/>
}

@section Scripts
{
    <script src="~/plugins/moment/moment.min.js"></script>
    <script src="~/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
    <script src="~/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="~/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="~/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="~/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
    <script src="~/js/extensions/datatables/lang.js"></script>
    <script src="~/plugins/select2/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            var languageTable = $('#languageTable');
            languageTable.DataTable({
                language: datatablesLangKor(),
                autoWidth: false,
                ordering: false,
                searching: false,
                paging: false,
                info: false
            });
            languageTable.show();

            var presetLanguageTable = $('#presetLanguageTable');
            presetLanguageTable.DataTable({
                language: datatablesLangKor(),
                autoWidth: false,
                ordering: false,
                searching: false,
                paging: false,
                info: false
            });
            presetLanguageTable.show();

            $('#reservationTime').datetimepicker(dateTimePickerOption_UtcAddOneDay);

            $('#presetSelect').select2();
            $('#presetSelect').on('select2:select',
                function(e) {
                    onPresetChanged(e);
                });
            onPresetChanged();
            if ($('#presetSelect').select2('data').length === 0) {
                addPreset();
            }
        });

        function onPresetChanged(e) {
            $('#presetSelect').find('option[value="0"]').remove();

            if ($('#presetSelect').select2('data').length === 0 ||
                $('#presetSelect').select2('data')[0].id === 0) {

                $('#presetSeq').val(0);
                return;
            }

            $.ajax({
                url: '/api/operation/message-notification/get-preset-detail',
                data: {
                    seq: $('#presetSelect').select2('data')[0].id
                },
                dataType: 'json',
                method: 'POST',
                success: function(preset) {
                    $('#presetSeq').val(preset.Seq);
                    $('#presetName').val(preset.PresetName);
                    $('#presetMessageText').val(preset.Message);
                },
                error: function(xhr, status, error) {
                    alert(xhr.status); // 에러코드(404, 500 등)
                    alert(xhr.responseText); // html 포맷의 에러 메시지
                    alert(status); // 'error'
                    alert(error); // 'Not Found'
                }
            });
        }

        function addPreset() {
            addOption(0, '(NEW)');
        }

        function savePreset() {
            let presetName = $('#presetName').val();
            if (presetName === null || presetName === undefined || presetName === "") {
                alert("프리셋 이름을 설정해주세요.");
            }

            let seq = $('#presetSeq').val() * 1;
            let message = $('#presetMessageText').val();

            $.ajax({
                url: '/api/operation/message-notification/save-preset',
                data: {
                    seq: seq,
                    presetName: presetName,
                    message: message
                },
                dataType: 'json',
                method: 'POST',
                success: function (resultSeq) {
                    if (seq === 0) {
                        $('#presetSelect option[value=' + seq + ']').remove();
                        addOption(resultSeq, presetName);
                    } else {
                        $('#presetSelect option[value=' + seq + ']').text(presetName);
                        $('#presetSelect').select2();
                    }
                    alert('저장되었습니다.');
                },
                error: function(xhr, status, error) {
                    alert(xhr.status);       // 에러코드(404, 500 등)
                    alert(xhr.responseText); // html 포맷의 에러 메시지
                    alert(status);           // 'error'
                    alert(error);            // 'Not Found'
                }
            });
        }

        function usePreset() {
            $('#messageText').val($('#presetMessageText').val());
        }

        function reserve() {
            var messages = $('#messageText').val();
            var reservationTime = $('#reservationTimeValue').val();
            let reservationTimeMoment = moment.utc(reservationTime);

            if (moment().utc().isAfter(reservationTimeMoment)) {
                alert("예약 시간이 현재 시간보다 이전으로 설정되어 있습니다.");
                return;
            }

            if (moment().utc().add(1, 'minutes').isAfter(reservationTimeMoment)) {
                if (confirm('설정한 시간이 현재로부터 1분미만입니다. 예약하시겠습니까?') !== true)
                    return;
            } else {
                if (confirm('예약하시겠습니까?') !== true)
                    return;
            }

            $.ajax({
                url: '/api/operation/message-notification/reserve',
                data: {
                    messages: messages,
                    reservationTime: reservationTime
                },
                dataType: 'text',
                method: 'POST',
                success: function () {
                    alert('예약되었습니다.');
                },
                error: function (xhr, status, error) {
                    alert(xhr.responseText); // html 포맷의 에러 메시지
                }
            });
        }

        function addOption(id, text) {
            if ($('#presetSelect').find('option[value="' + id + '"]').length > 0) {
                return;
            }

            var newOption = new Option(text, id, false, false);
            $('#presetSelect').append(newOption).val(id).trigger('change');

            $('#presetSeq').val(id);
        }

        function onMessageTextClicked() {
            openLanguageTextInputPopup($('#messageText').val(),
                function (text) {
                    $('#messageText').val(text);
                });
        }

        function onPresetMessageTextClicked() {
            openLanguageTextInputPopup($('#presetMessageText').val(),
                function (text) {
                    $('#presetMessageText').val(text);
                });
        }
    </script>
}